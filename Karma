local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Создаем ScreenGui и Frame для UI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "HighlightGui"
screenGui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Name = "HighlightFrame"
frame.Size = UDim2.new(0, 220, 0, 190)
frame.Position = UDim2.new(0, 10, 0, 10)
frame.BackgroundColor3 = Color3.new(1, 1, 1)
frame.BackgroundTransparency = 0.9
frame.Parent = screenGui

-- Универсальная функция создания кнопок
local function createButton(name, text, position, color)
    local btn = Instance.new("TextButton")
    btn.Name = name
    btn.Size = UDim2.new(1, -20, 0, 50)
    btn.Position = position
    btn.Text = text
    btn.BackgroundColor3 = color
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Parent = frame
    return btn
end

-- Создаем кнопки
local highlightButton = createButton("HighlightButton", "Highlight Players", UDim2.new(0, 10, 0, 10), Color3.fromRGB(0, 128, 255))
local respawnButton = createButton("RespawnButton", "Handle Respawn", UDim2.new(0, 10, 0, 70), Color3.fromRGB(255, 0, 0))
local extraButton = createButton("ExtraButton", "Create Balls", UDim2.new(0, 10, 0, 130), Color3.fromRGB(0, 255, 0))

-- Проверка наличия ульты (замените под вашу логику)
local function hasUltimate()
    local ultimate = player:FindFirstChild("UltimateActive")
    return ultimate and ultimate.Value
end

-- Создание или обновление Chams подсветки для персонажа
local function ensureHighlight(character, color)
    if not character then return end
    local highlight = character:FindFirstChild("ChamsHighlight")
    if not highlight then
        highlight = Instance.new("Highlight")
        highlight.Name = "ChamsHighlight"
        highlight.Adornee = character
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        highlight.Parent = character
    end
    highlight.Enabled = true
    highlight.FillColor = color
    highlight.OutlineColor = color:Lighter()
end

-- Отключение подсветки персонажа
local function disableHighlight(character)
    if not character then return end
    local highlight = character:FindFirstChild("ChamsHighlight")
    if highlight then
        highlight.Enabled = false
    end
end

-- Создание или обновление BillboardGui с именем игрока
local function setupBillboardGui(playerToHighlight)
    local character = playerToHighlight.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end

    local billboardGui = character:FindFirstChild("BillboardGui")
    if not billboardGui then
        billboardGui = Instance.new("BillboardGui")
        billboardGui.Name = "BillboardGui"
        billboardGui.Adornee = character.HumanoidRootPart
        billboardGui.Size = UDim2.new(0, 200, 0, 50)
        billboardGui.StudsOffset = Vector3.new(0, 3, 0)
        billboardGui.AlwaysOnTop = true
        billboardGui.Parent = character

        local textLabel = Instance.new("TextLabel")
        textLabel.Name = "NameLabel"
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.BackgroundTransparency = 1
        textLabel.TextStrokeTransparency = 0.5
        textLabel.Text = playerToHighlight.Name
        textLabel.Parent = billboardGui
    end
end

-- Основная функция подсветки всех игроков и добавления Chams
local function highlightPlayers()
    for _, p in pairs(Players:GetPlayers()) do
        if p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            setupBillboardGui(p)

            local billboardGui = p.Character:FindFirstChild("BillboardGui")
            local textLabel = billboardGui and billboardGui:FindFirstChild("NameLabel")

            if textLabel then
                local targetColor = hasUltimate() and Color3.fromRGB(255, 0, 0) or Color3.fromRGB(255, 255, 255)
                TweenService:Create(textLabel, TweenInfo.new(0.3), {TextColor3 = targetColor}):Play()
            end

            if hasUltimate() then
                ensureHighlight(p.Character, Color3.fromRGB(255, 0, 0))
            else
                disableHighlight(p.Character)
            end
        end
    end
end

-- Обработка респавна с телепортом на место смерти и сообщением в чат
local function handleRespawn()
    local function onCharacterAdded(character)
        local humanoid = character:WaitForChild("Humanoid")
        local head = character:FindFirstChild("Head")

        local function onDied()
            if character.PrimaryPart then
                player:SetAttribute("LastDeathPosition", character.PrimaryPart.Position)
            end
        end

        humanoid.Died:Connect(onDied)

        local lastPos = player:GetAttribute("LastDeathPosition")
        if lastPos then
            character:SetPrimaryPartCFrame(CFrame.new(lastPos))
            player:SetAttribute("LastDeathPosition", nil)
            if head then
                local chatService = game:GetService("Chat")
                chatService:Chat(head, "Reverse Cursed Technique", Enum.ChatColor.Red)
            end
        end
    end

    player.CharacterAdded:Connect(onCharacterAdded)
    if player.Character then
        onCharacterAdded(player.Character)
    end
end

-- Создание анимированных синих и красных шаров вокруг игрока
local function createBalls()
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

    local blueBall = Instance.new("Part")
    blueBall.Shape = Enum.PartType.Ball
    blueBall.Size = Vector3.new(10, 10, 10)
    blueBall.Color = Color3.fromRGB(0, 0, 255)
    blueBall.Anchored = true
    blueBall.CanCollide = false
    blueBall.Position = humanoidRootPart.Position + Vector3.new(0, 40, 0)
    blueBall.Parent = workspace

    local redBall = Instance.new("Part")
    redBall.Shape = Enum.PartType.Ball
    redBall.Size = Vector3.new(5, 5, 5)
    redBall.Color = Color3.fromRGB(255, 0, 0)
    redBall.Anchored = true
    redBall.CanCollide = false
    redBall.Position = humanoidRootPart.Position
    redBall.Parent = workspace

    local redBallLight = Instance.new("PointLight", redBall)
    redBallLight.Color = Color3.fromRGB(255, 0, 0)
    redBallLight.Range = 20
    redBallLight.Brightness = 2

    local tweenInfo = TweenInfo.new(3, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut, -1, true)
    local goal = {Position = humanoidRootPart.Position + Vector3.new(0, 10, 0)}
    local tween = TweenService:Create(redBall, tweenInfo, goal)
    tween:Play()
end

-- Подключаем кнопки к функциям
highlightButton.MouseButton1Click:Connect(function()
    highlightPlayers()
end)

respawnButton.MouseButton1Click:Connect(function()
    handleRespawn()
end)

extraButton.MouseButton1Click:Connect(function()
    createBalls()
end)

-- Автоматическое обновление подсветки с Chams каждые 0.5 секунды
spawn(function()
    while true do
        highlightPlayers()
        wait(0.5)
    end
end)
