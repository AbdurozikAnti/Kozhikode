-- Подключаем библиотеку Rayfield
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

-- Создаем окно
local Window = Rayfield:CreateWindow({
    Name = "MM2 Ultimate Script",
    LoadingTitle = "Загрузка...",
    LoadingSubtitle = "запуск функций",
    ConfigurationSaving = { Enabled = true }
})

-- Настройки
local Config = {
    ESP = false,
    AutoFarm = false,
    WalkSpeed = 30,
}

local ESPObjects = {}

-- Функция определения роли
local function GetRole(player)
    if not player.Character then return "Innocent" end
    for _, tool in ipairs(player.Backpack:GetChildren()) do
        if tool:IsA("Tool") then
            if string.lower(tool.Name):find("knife") then
                return "Murderer"
            elseif string.lower(tool.Name):find("gun") then
                return "Sheriff"
            end
        end
    end
    for _, tool in ipairs(player.Character:GetChildren()) do
        if tool:IsA("Tool") then
            if string.lower(tool.Name):find("knife") then
                return "Murderer"
            elseif string.lower(tool.Name):find("gun") then
                return "Sheriff"
            end
        end
    end
    return "Innocent"
end

-- Создаем ESP
local function CreateESP(player)
    if ESPObjects[player] then return end
    if not player.Character then return end

    local highlight = Instance.new("Highlight")
    highlight.Adornee = player.Character
    highlight.FillTransparency = 0.7
    highlight.OutlineTransparency = 0.3
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = player.Character

    ESPObjects[player] = highlight
end

local function UpdateESP()
    for player, highlight in pairs(ESPObjects) do
        if player.Character then
            local role = GetRole(player)
            if role == "Murderer" then
                highlight.FillColor = Color3.fromRGB(255, 0, 0)
                highlight.OutlineColor = Color3.fromRGB(255, 0, 0)
            elseif role == "Sheriff" then
                highlight.FillColor = Color3.fromRGB(0, 0, 255)
                highlight.OutlineColor = Color3.fromRGB(0, 0, 255)
            else
                highlight.FillColor = Color3.fromRGB(0, 255, 0)
                highlight.OutlineColor = Color3.fromRGB(0, 255, 0)
            end
            highlight.Enabled = Config.ESP
        else
            highlight:Destroy()
            ESPObjects[player] = nil
        end
    end
end

-- Автофарм — сбор оружия
local function AutoFarm()
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = LocalPlayer.Character.HumanoidRootPart
    for _, item in pairs(Workspace:GetChildren()) do
        if item:IsA("Tool") and item.Handle and (item.Handle.Position - hrp.Position).Magnitude < 20 then
            firetouchinterest(hrp, item.Handle, 0)
            firetouchinterest(hrp, item.Handle, 1)
        end
    end
end

-- GUI вкладка
local MainTab = Window:CreateTab("Главная")

MainTab:CreateToggle({
    Name = "ESP с цветами ролей",
    CurrentValue = false,
    Callback = function(value)
        Config.ESP = value
        if not value then
            for _, h in pairs(ESPObjects) do
                h:Destroy()
            end
            ESPObjects = {}
        end
    end
})

MainTab:CreateToggle({
    Name = "Автофарм оружия",
    CurrentValue = false,
    Callback = function(value)
        Config.AutoFarm = value
    end
})

MainTab:CreateSlider({
    Name = "Скорость ходьбы",
    Range = {16, 50},
    Increment = 1,
    Suffix = " WalkSpeed",
    CurrentValue = Config.WalkSpeed,
    Callback = function(value)
        Config.WalkSpeed = value
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.WalkSpeed = value
        end
    end
})

-- Обновления
RunService.Heartbeat:Connect(function()
    if Config.ESP then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                CreateESP(player)
            end
        end
        UpdateESP()
    end

    if Config.AutoFarm then
        AutoFarm()
    end

    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = Config.WalkSpeed
    end
end)
