local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local camera = workspace.CurrentCamera

-- Создаем GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "EpicHighlightGui"
screenGui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Name = "MainFrame"
frame.Size = UDim2.new(0, 240, 0, 220)
frame.Position = UDim2.new(0, 15, 0, 15)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
frame.BackgroundTransparency = 0.4
frame.BorderSizePixel = 0
frame.Parent = screenGui
frame.ClipsDescendants = true

local function createButton(name, text, pos, color)
    local btn = Instance.new("TextButton")
    btn.Name = name
    btn.Size = UDim2.new(1, -30, 0, 50)
    btn.Position = pos
    btn.BackgroundColor3 = color
    btn.Text = text
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 20
    btn.AutoButtonColor = true
    btn.Parent = frame

    -- Плавное изменение цвета при наведении
    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = color:Lighter(0.4)}):Play()
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = color}):Play()
    end)
    return btn
end

local highlightButton = createButton("HighlightBtn", "Toggle Highlight", UDim2.new(0, 15, 0, 15), Color3.fromRGB(0, 120, 255))
local respawnButton = createButton("RespawnBtn", "Handle Respawn", UDim2.new(0, 15, 0, 75), Color3.fromRGB(255, 50, 50))
local extraButton = createButton("ExtraBtn", "Create Balls", UDim2.new(0, 15, 0, 135), Color3.fromRGB(0, 200, 120))

-- Проверка наличия ульты (замените под свою логику)
local function hasUltimate()
    local ult = player:FindFirstChild("UltimateActive")
    return ult and ult.Value
end

-- Эффект пульсации цвета (возвращает циклически изменяющийся цвет)
local pulseSpeed = 2.5
local function getPulseColor(baseColor)
    local t = tick() * pulseSpeed
    local alpha = (math.sin(t) + 1) / 2 -- 0..1 пульсирование
    return baseColor:Lerp(Color3.new(1,1,1), alpha * 0.5)
end

-- Словарь для BillboardGui, Highlight и Tracers
local visuals = {}

-- Создаем/обновляем визуальные эффекты для игрока
local function updatePlayerVisuals(p)
    if not p.Character or not p.Character:FindFirstChild("HumanoidRootPart") then return end

    local char = p.Character
    local hrp = char.HumanoidRootPart

    -- BillboardGui с именем
    local bill = char:FindFirstChild("BillboardGui")
    if not bill then
        bill = Instance.new("BillboardGui")
        bill.Name = "BillboardGui"
        bill.Size = UDim2.new(0, 230, 0, 40)
        bill.Adornee = hrp
        bill.StudsOffset = Vector3.new(0, 2.5, 0)
        bill.AlwaysOnTop = true
        bill.Parent = char

        local textLabel = Instance.new("TextLabel")
        textLabel.Name = "NameLabel"
        textLabel.BackgroundTransparency = 1
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.Font = Enum.Font.GothamBold
        textLabel.TextSize = 20
        textLabel.TextStrokeTransparency = 0.4
        textLabel.Parent = bill
    end

    -- Highlight для Chams
    local highlight = char:FindFirstChild("ChamsHighlight")
    if not highlight then
        highlight = Instance.new("Highlight")
        highlight.Name = "ChamsHighlight"
        highlight.Adornee = char
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        highlight.Parent = char
    end

    -- Трассеры (line) в 2D UI
    local tracer = visuals[p.UserId]
    if not tracer then
        tracer = Instance.new("Frame")
        tracer.Name = "TracerLine_" .. p.Name
        tracer.Size = UDim2.new(0, 2, 0, 0)
        tracer.AnchorPoint = Vector2.new(0.5, 1)
        tracer.BackgroundColor3 = Color3.new(1,0,0)
        tracer.BorderSizePixel = 0
        tracer.Parent = screenGui
        visuals[p.UserId] = tracer
    end

    -- Обновляем цвета и текст
    local baseColor = hasUltimate() and Color3.fromRGB(255, 0, 0) or Color3.fromRGB(200, 200, 200)
    local pulseCol = getPulseColor(baseColor)
    bill.NameLabel.Text = p.Name
    bill.NameLabel.TextColor3 = pulseCol
    bill.NameLabel.TextStrokeColor3 = baseColor

    highlight.Enabled = true
    highlight.FillColor = pulseCol
    highlight.OutlineColor = baseColor:Lighter()

    -- Обновляем трассер с позицией
    local vector, onScreen = camera:WorldToViewportPoint(hrp.Position)
    if onScreen then
        tracer.Visible = true
        local screenPos = Vector2.new(vector.X, vector.Y)
        local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y)
        local length = (screenCenter - screenPos).Magnitude

        tracer.Size = UDim2.new(0, 2, 0, length)
        tracer.Position = UDim2.new(0, screenPos.X, 0, screenPos.Y)
        local angle = math.deg(math.atan2(screenCenter.Y - screenPos.Y, screenCenter.X - screenPos.X)) - 90
        tracer.Rotation = angle
        tracer.BackgroundColor3 = pulseCol
    else
        tracer.Visible = false
    end
end

-- Удаляем визуалы игрока, если он покинул игру
local function cleanupVisuals(userId)
    if visuals[userId] then
        visuals[userId]:Destroy()
        visuals[userId] = nil
    end
end

-- Главная функция обновления всех визуалов
local function updateAllVisuals()
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player then
            if p.Character and p.Character.PrimaryPart then
                updatePlayerVisuals(p)
            else
                cleanupVisuals(p.UserId)
            end
        else
            -- Для локального игрока очищаем трассер
            cleanupVisuals(p.UserId)
        end
    end
end

-- Функция респавна с телепортом на последнее место смерти и сообщением в чат
local function handleRespawn()
    local function onCharacterAdded(character)
        local humanoid = character:WaitForChild("Humanoid")
        local head = character:FindFirstChild("Head")
        humanoid.Died:Connect(function()
            if character.PrimaryPart then
                player:SetAttribute("LastDeathPosition", character.PrimaryPart.Position)
            end
        end)

        local lastPos = player:GetAttribute("LastDeathPosition")
        if lastPos then
            character:SetPrimaryPartCFrame(CFrame.new(lastPos))
            player:SetAttribute("LastDeathPosition", nil)
            if head then
                local chatService = game:GetService("Chat")
                chatService:Chat(head, "Reverse Cursed Technique", Enum.ChatColor.Red)
            end
        end
    end

    player.CharacterAdded:Connect(onCharacterAdded)
    if player.Character then
        onCharacterAdded(player.Character)
    end
end

-- Создаем анимированные синие и красные шары вокруг игрока
local function createBalls()
    local character = player.Character or player.CharacterAdded:Wait()
    local hrp = character:WaitForChild("HumanoidRootPart")

    local blueBall = Instance.new("Part")
    blueBall.Shape = Enum.PartType.Ball
    blueBall.Size = Vector3.new(10, 10, 10)
    blueBall.Color = Color3.fromRGB(0, 0, 255)
    blueBall.Anchored = true
    blueBall.CanCollide = false
    blueBall.Position = hrp.Position + Vector3.new(0, 40, 0)
    blueBall.Parent = workspace

    local redBall = Instance.new("Part")
    redBall.Shape = Enum.PartType.Ball
    redBall.Size = Vector3.new(5, 5, 5)
    redBall.Color = Color3.fromRGB(255, 0, 0)
    redBall.Anchored = true
    redBall.CanCollide = false
    redBall.Position = hrp.Position
    redBall.Parent = workspace

    local redBallLight = Instance.new("PointLight", redBall)
    redBallLight.Color = Color3.fromRGB(255, 0, 0)
    redBallLight.Range = 20
    redBallLight.Brightness = 2

    local tweenInfo = TweenInfo.new(3, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut, -1, true)
    local goal = {Position = hrp.Position + Vector3.new(0, 10, 0)}
    local tween = TweenService:Create(redBall, tweenInfo, goal)
    tween:Play()
end

-- Тоггл подсветки по кнопке
local highlightEnabled = false
highlightButton.MouseButton1Click:Connect(function()
    highlightEnabled = not highlightEnabled
    if not highlightEnabled then
        -- Отключаем подсветки и трассеры
        for _, p in pairs(Players:GetPlayers()) do
            if p.Character then
                local highlight = p.Character:FindFirstChild("ChamsHighlight")
                if highlight then highlight.Enabled = false end

                local billboard = p.Character:FindFirstChild("BillboardGui")
                if billboard then
                    local label = billboard:FindFirstChild("NameLabel")
                    if label then label.TextColor3 = Color3.fromRGB(255,255,255) end
                end
            end
            cleanupVisuals(p.UserId)
        end
    end
end)

respawnButton.MouseButton1Click:Connect(handleRespawn)
extraButton.MouseButton1Click:Connect(createBalls)

-- Постоянное обновление с оптимизацией
RunService.RenderStepped:Connect(function()
    if highlightEnabled or hasUltimate() then
        updateAllVisuals()
    else
        -- Очищаем визуалы если подсветка выключена и ульты нет
        for _, p in pairs(Players:GetPlayers()) do
            if visuals[p.UserId] then
                visuals[p.UserId].Visible = false
            end
        end
    end
end)
