-- █▀▀ █▀▀█ █▀▀▄ █▀▀ ▀▀█▀▀ █▀▀ █▀▀█ █▀▀▄ 
-- █░░ █▄▄█ █▀▀▄ █▀▀ ░░█░░ █▀▀ █▄▄█ █▀▀▄ 
-- ▀▀▀ ▀░░▀ ▀▀▀░ ▀▀▀ ░░▀░░ ▀▀▀ ▀░░▀ ▀▀▀░ 
-- MM2 ULTIMATE v0.1 | Современное меню с вкладками, всеми функциями и обновляемой инфой

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UIS = game:GetService("UserInputService")

local SCRIPT_VERSION = "v0.1"

local Window = Rayfield:CreateWindow({
    Name = "Murder Mystery 2",
    LoadingTitle = "Загрузка меню...",
    LoadingSubtitle = SCRIPT_VERSION,
    ConfigurationSaving = { Enabled = true },
    KeySystem = false
})

local CheatConfig = {
    ESP = {
        Enabled = false,
        Tracers = false,
        ShowDistance = true,
        Colors = {
            Murderer = Color3.new(1, 0, 0),
            Sheriff = Color3.new(0, 0, 1),
            Innocent = Color3.new(0, 1, 0)
        }
    },
    Fly = {
        Enabled = false,
        Speed = 50
    },
    Autofarm = {
        Enabled = false
    },
    Knife = {
        AutoStab = false,
        AimKnife = false,
        SilentKnife = false
    },
    Gun = {
        AutoGrab = false,
        ESP = false
    }
}

local ESPObjects, TracerObjects = {}, {}

-- Роли
local function GetPlayerRole(player)
    if player.Character then
        for _, tool in ipairs(player.Backpack:GetChildren()) do
            if tool:IsA("Tool") then
                if string.lower(tool.Name):find("knife") then
                    return "Murderer"
                elseif string.lower(tool.Name):find("gun") then
                    return "Sheriff"
                end
            end
        end
        for _, tool in ipairs(player.Character:GetChildren()) do
            if tool:IsA("Tool") then
                if string.lower(tool.Name):find("knife") then
                    return "Murderer"
                elseif string.lower(tool.Name):find("gun") then
                    return "Sheriff"
                end
            end
        end
    end
    return "Innocent"
end

-- ESP
local function RefreshPlayerESP(player)
    if player == LocalPlayer then return end
    if ESPObjects[player] then
        if ESPObjects[player].Highlight then ESPObjects[player].Highlight:Destroy() end
        if ESPObjects[player].Billboard then ESPObjects[player].Billboard:Destroy() end
        ESPObjects[player] = nil
    end
    if not player.Character or not player.Character:FindFirstChild("Head") then return end

    local highlight = Instance.new("Highlight")
    highlight.Name = player.Name .. "_ESP"
    highlight.Adornee = player.Character
    highlight.FillTransparency = 0.7
    highlight.OutlineTransparency = 0.3
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop

    local billboard = Instance.new("BillboardGui")
    billboard.Name = player.Name .. "_Info"
    billboard.Size = UDim2.new(0, 200, 0, 60)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.Adornee = player.Character.Head
    billboard.AlwaysOnTop = true

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.new(1, 1, 1)
    textLabel.TextSize = 14
    textLabel.Font = Enum.Font.GothamBold
    textLabel.TextStrokeTransparency = 0.3
    textLabel.Parent = billboard

    billboard.Parent = player.Character.Head
    highlight.Parent = player.Character

    ESPObjects[player] = {
        Highlight = highlight,
        Billboard = billboard,
        TextLabel = textLabel
    }
end

local function UpdateESP()
    for player, espData in pairs(ESPObjects) do
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local role = GetPlayerRole(player)
            local color = CheatConfig.ESP.Colors[role]
            local distance = math.floor(
                (player.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
            )
            local dist_str = CheatConfig.ESP.ShowDistance and (" [" .. tostring(distance) .. "m]") or ""
            espData.Highlight.FillColor = color
            espData.Highlight.OutlineColor = color
            espData.TextLabel.TextColor3 = color
            espData.TextLabel.Text = player.Name .. " - " .. role .. dist_str
            espData.Highlight.Enabled = CheatConfig.ESP.Enabled
            espData.Billboard.Enabled = CheatConfig.ESP.Enabled
        else
            if espData.Highlight then espData.Highlight:Destroy() end
            if espData.Billboard then espData.Billboard:Destroy() end
            ESPObjects[player] = nil
        end
    end
end

local function SetupPlayerESP(player)
    player.CharacterAdded:Connect(function()
        wait(1)
        if CheatConfig.ESP.Enabled then
            RefreshPlayerESP(player)
        end
    end)
    if player.Character and CheatConfig.ESP.Enabled then
        RefreshPlayerESP(player)
    end
end

local function SetupAllESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            SetupPlayerESP(player)
        end
    end
    Players.PlayerAdded:Connect(function(player)
        SetupPlayerESP(player)
    end)
end

-- Tracers
local function CreateTracer(player)
    if player == LocalPlayer then return end
    if TracerObjects[player] then return end

    local tracer = Instance.new("Part")
    tracer.Name = player.Name .. "_Tracer"
    tracer.Anchored = true
    tracer.CanCollide = false
    tracer.Material = Enum.Material.Neon
    tracer.Size = Vector3.new(0.1, 0.1, 0.1)
    tracer.Transparency = 0.5
    tracer.Parent = Workspace

    TracerObjects[player] = tracer
    return tracer
end

local function UpdateTracers()
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    local fromPos = LocalPlayer.Character.HumanoidRootPart.Position
    for player, tracer in pairs(TracerObjects) do
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local toPos = player.Character.HumanoidRootPart.Position
            local color = CheatConfig.ESP.Colors[GetPlayerRole(player)]
            tracer.BrickColor = BrickColor.new(color)
            tracer.Size = Vector3.new(0.1, 0.1, (fromPos - toPos).Magnitude)
            tracer.CFrame = CFrame.lookAt(fromPos, toPos) * CFrame.new(0, 0, -tracer.Size.Z/2)
            tracer.Transparency = CheatConfig.ESP.Tracers and 0.3 or 1
            tracer.Parent = Workspace
        else
            if tracer then tracer:Destroy() end
            TracerObjects[player] = nil
        end
    end
end

-- Fly
local FlyConnection
local function ToggleFly()
    if CheatConfig.Fly.Enabled then
        local bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.Name = "FlyVelocity"
        bodyVelocity.MaxForce = Vector3.new(40000, 40000, 40000)
        bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        bodyVelocity.Parent = LocalPlayer.Character.HumanoidRootPart

        FlyConnection = RunService.Heartbeat:Connect(function()
            if not CheatConfig.Fly.Enabled or not LocalPlayer.Character then
                bodyVelocity:Destroy()
                FlyConnection:Disconnect()
                return
            end

            local camera = Workspace.CurrentCamera
            local root = LocalPlayer.Character.HumanoidRootPart

            local direction = Vector3.new(0, 0, 0)
            if UIS:IsKeyDown(Enum.KeyCode.W) then
                direction = direction + camera.CFrame.LookVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.S) then
                direction = direction - camera.CFrame.LookVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.A) then
                direction = direction - camera.CFrame.RightVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.D) then
                direction = direction + camera.CFrame.RightVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.Space) then
                direction = direction + Vector3.new(0, 1, 0)
            end
            if UIS:IsKeyDown(Enum.KeyCode.LeftShift) then
                direction = direction + Vector3.new(0, -1, 0)
            end

            bodyVelocity.Velocity = direction * CheatConfig.Fly.Speed
        end)
    else
        if FlyConnection then
            FlyConnection:Disconnect()
        end
        local velocity = LocalPlayer.Character.HumanoidRootPart:FindFirstChild("FlyVelocity")
        if velocity then
            velocity:Destroy()
        end
    end
end

---------------------------------------
-- 1. Chams & info (ESP)
---------------------------------------
local ESPTab = Window:CreateTab("Chams & info", 0)
local InfoSection = ESPTab:CreateSection("Info")
local InfoLabel = ESPTab:CreateLabel({
    Name = "Info",
    Content = "Murder is: nil\nSheriff/Hero is: nil\nGun Dropped: No"
})
ESPTab:CreateToggle({
    Name = "Chams (ESP по ролям + дистанция)",
    CurrentValue = false,
    Callback = function(Value)
        CheatConfig.ESP.Enabled = Value
        if not Value then
            for player, espData in pairs(ESPObjects) do
                if espData.Highlight then espData.Highlight:Destroy() end
                if espData.Billboard then espData.Billboard:Destroy() end
            end
            ESPObjects = {}
        else
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer then
                    RefreshPlayerESP(player)
                end
            end
        end
    end
})
ESPTab:CreateToggle({
    Name = "Показывать дистанцию до игроков",
    CurrentValue = true,
    Callback = function(Value) CheatConfig.ESP.ShowDistance = Value end
})
ESPTab:CreateToggle({
    Name = "Трейсеры (линии до игроков)",
    CurrentValue = false,
    Callback = function(Value)
        CheatConfig.ESP.Tracers = Value
        if not Value then
            for player, tracer in pairs(TracerObjects) do
                if tracer then tracer:Destroy() end
            end
            TracerObjects = {}
        else
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer then
                    CreateTracer(player)
                end
            end
        end
    end
})

---------------------------------------
-- 2. Gun
---------------------------------------
local GunTab = Window:CreateTab("Gun", 0)
GunTab:CreateButton({
    Name = "Взять пушку",
    Callback = function()
        local gun = Workspace:FindFirstChild("GunDrop")
        if gun then
            LocalPlayer.Character.HumanoidRootPart.CFrame = gun.CFrame
        end
    end
})
GunTab:CreateToggle({
    Name = "Auto Grab Gun",
    CurrentValue = false,
    Callback = function(Value)
        CheatConfig.Gun.AutoGrab = Value
    end
})
GunTab:CreateToggle({
    Name = "ESP Gun (подсветка пушки)",
    CurrentValue = false,
    Callback = function(Value)
        CheatConfig.Gun.ESP = Value
    end
})

---------------------------------------
-- 3. Knife
---------------------------------------
local KnifeTab = Window:CreateTab("Knife", 0)
KnifeTab:CreateToggle({
    Name = "Auto Stab / Телекилл",
    CurrentValue = false,
    Callback = function(Value)
        CheatConfig.Knife.AutoStab = Value
    end
})
KnifeTab:CreateToggle({
    Name = "AimKnife",
    CurrentValue = false,
    Callback = function(Value)
        CheatConfig.Knife.AimKnife = Value
    end
})
KnifeTab:CreateToggle({
    Name = "SilentKnife",
    CurrentValue = false,
    Callback = function(Value)
        CheatConfig.Knife.SilentKnife = Value
    end
})

---------------------------------------
-- 4. Autofarm
---------------------------------------
local AutofarmTab = Window:CreateTab("Autofarm", 0)
AutofarmTab:CreateToggle({
    Name = "Автофарм монет",
    CurrentValue = false,
    Callback = function(Value)
        CheatConfig.Autofarm.Enabled = Value
    end
})
AutofarmTab:CreateButton({
    Name = "Авто-выбор карты (пример)",
    Callback = function()
        -- Здесь можно реализовать авто-голосование за карту
    end
})
AutofarmTab:CreateButton({
    Name = "Авто-выбор роли (пример)",
    Callback = function()
        -- Здесь можно реализовать попытку выбрать роль (если вообще возможно)
    end
})

---------------------------------------
-- 5. Settings
---------------------------------------
local SettingsTab = Window:CreateTab("Settings", 0)
SettingsTab:CreateToggle({
    Name = "Включить полет (WASD + Space/Shift)",
    CurrentValue = false,
    Callback = function(Value)
        CheatConfig.Fly.Enabled = Value
        ToggleFly()
    end
})
SettingsTab:CreateSlider({
    Name = "Скорость полета",
    Range = {10, 100},
    Increment = 5,
    Suffix = "speed",
    CurrentValue = 50,
    Callback = function(Value) CheatConfig.Fly.Speed = Value end
})
SettingsTab:CreateButton({
    Name = "Сброс/Unload меню",
    Callback = function()
        Rayfield:Destroy()
    end
})

---------------------------------------
-- Gun ESP Highlight (по желанию)
---------------------------------------
local GunESPObj
local function UpdateGunESP()
    if not CheatConfig.Gun.ESP then
        if GunESPObj then
            GunESPObj:Destroy()
            GunESPObj = nil
        end
        return
    end
    local gun = Workspace:FindFirstChild("GunDrop")
    if not gun then
        if GunESPObj then
            GunESPObj:Destroy()
            GunESPObj = nil
        end
        return
    end
    if not GunESPObj then
        GunESPObj = Instance.new("Highlight")
        GunESPObj.Name = "GunESP"
        GunESPObj.Adornee = gun
        GunESPObj.FillColor = Color3.new(1, 1, 0)
        GunESPObj.OutlineColor = Color3.new(1, 1, 0)
        GunESPObj.Parent = gun
    end
end

---------------------------------------
-- Auto Grab Gun (по желанию)
---------------------------------------
local function UpdateAutoGrabGun()
    if not CheatConfig.Gun.AutoGrab then return end
    local gun = Workspace:FindFirstChild("GunDrop")
    if gun and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.CFrame = gun.CFrame
    end
end

---------------------------------------
-- Auto Stab / Knife Features (пример)
---------------------------------------
local function UpdateAutoStab()
    if not CheatConfig.Knife.AutoStab then return end
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            LocalPlayer.Character.HumanoidRootPart.CFrame = player.Character.HumanoidRootPart.CFrame
            wait(0.2)
        end
    end
end

---------------------------------------
-- Autofarm (пример)
---------------------------------------
local function UpdateAutofarm()
    if not CheatConfig.Autofarm.Enabled then return end
    -- Здесь можно реализовать автофарм монет, телепорт к монетам и т.д.
end

---------------------------------------
-- Info обновление
---------------------------------------
local function UpdateInfo()
    local murderer, sheriff = "nil", "nil"
    local gun_dropped = false
    for _, player in pairs(Players:GetPlayers()) do
        local role = GetPlayerRole(player)
        if role == "Murderer" then murderer = player.Name end
        if role == "Sheriff" then sheriff = player.Name end
    end
    local gun = Workspace:FindFirstChild("GunDrop")
    gun_dropped = gun and "Yes" or "No"
    local info =
        "Murder is: " .. tostring(murderer) ..
        "\nSheriff/Hero is: " .. tostring(sheriff) ..
        "\nGun Dropped: " .. gun_dropped
    InfoLabel:Set(info)
end

---------------------------------------
-- Основной цикл обновления
---------------------------------------
RunService.Heartbeat:Connect(function()
    UpdateInfo()
    if CheatConfig.ESP.Enabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character then
                if not ESPObjects[player] then
                    RefreshPlayerESP(player)
                end
            end
        end
        UpdateESP()
    end
    if CheatConfig.ESP.Tracers then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character then
                if not TracerObjects[player] then
                    CreateTracer(player)
                end
            end
        end
        UpdateTracers()
    end
    UpdateGunESP()
    UpdateAutoGrabGun()
    UpdateAutoStab()
    UpdateAutofarm()
end)

SetupAllESP()

Rayfield:Notify({
    Title = "MM2 ULTIMATE " .. SCRIPT_VERSION .. " ЗАГРУЖЕН!",
    Content = "Современное меню, вкладки, ESP с дистанцией, трейсеры, авто-обновление инфы!",
    Duration = 8,
})

print("MM2 ULTIMATE v0.1 АКТИВИРОВАН!")
